<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal PGI</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3d5af1;
            --primary-light: #e8ecff;
            --primary-dark: #2a3db0;
            --accent: #f97316;
            --accent-light: #fff3e8;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --purple: #8b5cf6;
            --purple-light: #ede9fe;
            --bg: #f0f2fa;
            --surface: #ffffff;
            --border: #e2e5f1;
            --text: #1a1d2e;
            --text-muted: #6b7280;
            --radius: 14px;
            --radius-sm: 8px;
            --shadow: 0 4px 20px rgba(61,90,241,0.08);
            --shadow-lg: 0 12px 40px rgba(61,90,241,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }

        /* â”€â”€ BRANCH SELECTION â”€â”€ */
        .branch-screen {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #1a1d2e 0%, #2d3561 60%, #3d5af1 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000; padding: 20px;
        }
        .branch-screen.hidden { display: none; }

        .branch-card {
            background: rgba(255,255,255,0.06);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 24px;
            padding: 50px 40px;
            text-align: center;
            max-width: 440px; width: 100%;
            box-shadow: 0 30px 80px rgba(0,0,0,0.4);
        }
        .branch-card .logo {
            width: 64px; height: 64px;
            background: var(--primary);
            border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; margin: 0 auto 24px;
            box-shadow: 0 8px 24px rgba(61,90,241,0.4);
        }
        .branch-card h2 { font-size: 1.8em; color: white; font-weight: 800; margin-bottom: 8px; }
        .branch-card p { color: rgba(255,255,255,0.6); margin-bottom: 36px; font-size: 0.95em; }
        .branch-buttons { display: flex; flex-direction: column; gap: 12px; }
        .branch-btn {
            padding: 18px 24px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.08);
            color: white; border-radius: var(--radius);
            font-size: 1.1em; font-weight: 600;
            cursor: pointer; transition: all 0.25s;
            font-family: inherit;
            display: flex; align-items: center; gap: 12px; justify-content: center;
        }
        .branch-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(61,90,241,0.4);
        }

        /* â”€â”€ MAIN CONTAINER â”€â”€ */
        .container {
            max-width: 1300px;
            margin: 0 auto;
        }

        /* â”€â”€ HEADER â”€â”€ */
        .header {
            background: linear-gradient(135deg, #1a1d2e 0%, #2d3561 60%, #3d5af1 100%);
            border-radius: 20px 20px 0 0;
            padding: 28px 32px;
            display: flex; align-items: center; gap: 20px;
            flex-wrap: wrap;
        }
        .header-icon {
            width: 52px; height: 52px;
            background: rgba(255,255,255,0.12);
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
        }
        .header-text h1 { color: white; font-size: 1.6em; font-weight: 800; }
        .header-text p { color: rgba(255,255,255,0.6); font-size: 0.875em; margin-top: 2px; }
        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 10px; }
        .btn-ghost {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white; border-radius: var(--radius-sm);
            cursor: pointer; font-size: 0.85em;
            font-family: inherit; font-weight: 500;
            transition: all 0.2s;
        }
        .btn-ghost:hover { background: rgba(255,255,255,0.2); }

        /* â”€â”€ CALENDAR TOGGLE â”€â”€ */
        .calendar-toggle {
            background: var(--surface);
            padding: 16px 24px;
            display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }
        .toggle-label { font-weight: 700; font-size: 0.875em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .toggle-pills {
            display: flex; gap: 4px;
            background: var(--bg);
            padding: 4px; border-radius: 10px;
        }
        .toggle-pill {
            padding: 8px 20px;
            border: none; border-radius: 7px;
            font-family: inherit; font-weight: 600;
            font-size: 0.9em; cursor: pointer;
            transition: all 0.2s;
            background: transparent; color: var(--text-muted);
        }
        .toggle-pill.active {
            background: var(--surface);
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(61,90,241,0.15);
        }
        .toggle-pill.task-active {
            background: var(--surface);
            color: var(--accent);
            box-shadow: 0 2px 8px rgba(249,115,22,0.15);
        }

        /* â”€â”€ TOOLBAR â”€â”€ */
        .toolbar {
            background: var(--surface);
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 12px;
            flex-wrap: wrap;
        }
        .toolbar select {
            padding: 8px 12px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit; font-size: 0.9em;
            background: var(--bg); color: var(--text);
            cursor: pointer; min-width: 180px;
        }
        .toolbar select:focus { outline: none; border-color: var(--primary); }
        .filter-label { font-weight: 600; font-size: 0.875em; color: var(--text-muted); }

        /* â”€â”€ NAV â”€â”€ */
        .cal-nav {
            background: var(--surface);
            padding: 14px 24px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 2px solid var(--border);
            gap: 12px; flex-wrap: wrap;
        }
        .nav-btn {
            padding: 9px 18px;
            background: var(--primary-light);
            color: var(--primary); border: none;
            border-radius: var(--radius-sm);
            font-family: inherit; font-weight: 600;
            font-size: 0.9em; cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: var(--primary); color: white; }
        .month-year { font-size: 1.3em; font-weight: 800; color: var(--text); }

        /* â”€â”€ CALENDAR GRID â”€â”€ */
        .calendar-wrap { background: var(--surface); padding: 24px; overflow-x: auto; }
        .days-header {
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 8px; margin-bottom: 8px; min-width: 700px;
        }
        .day-name {
            text-align: center; font-weight: 700;
            font-size: 0.8em; letter-spacing: 0.04em;
            color: var(--text-muted);
            padding: 8px; text-transform: uppercase;
        }
        .day-name.weekend { color: var(--danger); }
        .days-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 8px; min-width: 700px;
        }
        .day-cell {
            min-height: 110px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            padding: 10px;
            background: var(--surface);
            cursor: pointer; transition: all 0.2s;
            position: relative;
        }
        .day-cell:hover:not(.empty) {
            border-color: var(--primary);
            box-shadow: var(--shadow);
            transform: translateY(-1px);
        }
        .day-cell.empty { background: var(--bg); cursor: default; border-color: transparent; }
        .day-cell.today { border-color: var(--primary); background: var(--primary-light); }
        .day-cell.red-day { background: #fff8f8; }

        .day-number {
            font-size: 1em; font-weight: 700; color: var(--text);
            margin-bottom: 4px; font-family: 'DM Mono', monospace;
        }
        .day-number.red { color: var(--danger); }
        .day-number.today-num {
            color: white;
            background: var(--primary);
            width: 26px; height: 26px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.85em;
        }

        .holiday-label {
            font-size: 0.65em;
            color: var(--danger);
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: 5px;
            display: block;
        }

        /* Shift items */
        .shift-list { display: flex; flex-direction: column; gap: 3px; }
        .shift-item {
            padding: 4px 7px;
            border-radius: 5px;
            font-size: 0.78em;
            font-weight: 500; line-height: 1.3;
        }
        .shift-item.libur { background: var(--danger-light); color: #b91c1c; }
        .shift-item.pulsor { background: var(--success-light); color: #065f46; }
        .shift-item.siang { background: var(--warning-light); color: #92400e; }
        .shift-item.normal { background: var(--primary-light); color: var(--primary-dark); }

        /* Task items */
        .task-list { display: flex; flex-direction: column; gap: 3px; }
        .task-item {
            padding: 4px 7px;
            border-radius: 5px;
            font-size: 0.78em;
            font-weight: 500; line-height: 1.3;
            display: flex; align-items: flex-start; gap: 4px;
        }
        .task-item.oneoff { background: var(--purple-light); color: #5b21b6; }
        .task-item.recurring { background: var(--accent-light); color: #c2410c; }
        .task-item.permanent-recurring { background: #e0f2fe; color: #0369a1; border-left: 2px solid #0ea5e9; }
        .task-item.recurring { background: var(--accent-light); color: #c2410c; }
        .task-item .task-icon { font-size: 0.9em; flex-shrink: 0; }

        /* â”€â”€ HOLIDAY SECTION â”€â”€ */
        .holiday-section {
            background: var(--surface);
            padding: 24px;
            border-top: 2px solid var(--border);
        }
        .section-title {
            font-size: 1em; font-weight: 800;
            color: var(--text); margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .holiday-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 10px;
        }
        .holiday-chip {
            display: flex; align-items: flex-start; gap: 10px;
            padding: 10px 14px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--danger);
        }
        .holiday-chip .hdate {
            font-family: 'DM Mono', monospace;
            font-size: 0.8em; font-weight: 500;
            color: var(--danger); white-space: nowrap;
        }
        .holiday-chip .hname {
            font-size: 0.85em; font-weight: 600; color: var(--text);
        }
        .no-holiday {
            color: var(--text-muted); font-size: 0.9em;
            font-style: italic;
        }

        /* â”€â”€ LEGEND â”€â”€ */
        .legend {
            background: var(--surface);
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            border-radius: 0 0 20px 20px;
            display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
        }
        .legend-label { font-size: 0.8em; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.83em; font-weight: 500; }
        .legend-dot { width: 10px; height: 10px; border-radius: 3px; }
        .ld-libur { background: var(--danger); }
        .ld-pulsor { background: var(--success); }
        .ld-siang { background: var(--warning); }
        .ld-normal { background: var(--primary); }
        .ld-oneoff { background: var(--purple); }
        .ld-recurring { background: var(--accent); }

        /* â”€â”€ MODAL â”€â”€ */
        .modal {
            display: none; position: fixed; inset: 0;
            background: rgba(26,29,46,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-box {
            background: var(--surface);
            border-radius: 20px;
            width: 100%; max-width: 520px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        .modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .modal-header h2 { font-size: 1.05em; font-weight: 800; }
        .modal-close {
            width: 32px; height: 32px;
            background: var(--bg); border: none; border-radius: 8px;
            cursor: pointer; font-size: 1.1em;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .modal-close:hover { background: var(--danger-light); color: var(--danger); }
        .modal-body { padding: 20px 24px; }
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex; gap: 8px; justify-content: flex-end;
        }

        .form-group { margin-bottom: 16px; }
        .form-label { font-size: 0.85em; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; display: block; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit; font-size: 0.95em;
            background: var(--bg); color: var(--text);
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none; border-color: var(--primary);
        }
        .form-textarea { min-height: 100px; resize: vertical; }

        .help-box {
            background: var(--bg);
            border-radius: var(--radius-sm);
            padding: 12px; font-size: 0.8em;
            color: var(--text-muted); margin-bottom: 14px;
            border-left: 3px solid var(--primary);
            line-height: 1.6;
        }

        /* recurring options */
        .recur-options {
            display: none;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px; background: var(--bg);
            margin-top: 10px;
        }
        .recur-options.visible { display: block; }
        .recur-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        .recur-row:last-child { margin-bottom: 0; }
        .recur-row label { font-size: 0.85em; font-weight: 600; color: var(--text-muted); min-width: 80px; }
        .checkboxes { display: flex; gap: 8px; flex-wrap: wrap; }
        .day-check { display: flex; align-items: center; gap: 4px; font-size: 0.82em; cursor: pointer; }
        .date-inputs {
            display: flex; flex-wrap: wrap; gap: 6px;
        }
        .date-num-input {
            width: 50px; padding: 6px 8px;
            border: 1.5px solid var(--border); border-radius: 6px;
            font-family: inherit; font-size: 0.85em;
            text-align: center; background: var(--surface);
        }
        .date-num-input:focus { outline: none; border-color: var(--primary); }

        /* Task list in modal */
        .task-existing { margin-bottom: 14px; }
        .task-existing-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 10px; border-radius: 8px;
            background: var(--bg); margin-bottom: 6px;
            font-size: 0.88em;
        }
        .task-existing-item span { flex: 1; }
        .task-badge {
            padding: 2px 8px; border-radius: 20px; font-size: 0.75em; font-weight: 600; margin-left: 8px;
        }
        .task-badge.oneoff { background: var(--purple-light); color: #5b21b6; }
        .task-badge.recurring { background: var(--accent-light); color: #c2410c; }
        .task-del-btn {
            border: none; background: none; cursor: pointer;
            color: var(--danger); font-size: 1em; padding: 2px 6px;
            border-radius: 4px; transition: background 0.2s;
        }
        .task-del-btn:hover { background: var(--danger-light); }

        /* Buttons */
        .btn {
            padding: 10px 20px; border: none;
            border-radius: var(--radius-sm);
            font-family: inherit; font-weight: 600;
            font-size: 0.9em; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary.task { background: var(--accent); }
        .btn-primary.task:hover { background: #ea6c0a; }
        .btn-danger { background: var(--danger-light); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-secondary { background: var(--bg); color: var(--text); }
        .btn-secondary:hover { background: var(--border); }

        /* Loading */
        .loading {
            text-align: center; padding: 40px;
            color: var(--primary); font-size: 1em;
            font-weight: 600;
        }
        .loading-dot { display: inline-block; animation: pulse 1.4s ease infinite; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        /* â”€â”€ RESPONSIVE â”€â”€ */
        @media (max-width: 768px) {
            body { padding: 0; }
            .header { border-radius: 0; padding: 18px 16px; }
            .calendar-wrap { padding: 12px; }
            .day-cell { min-height: 80px; padding: 6px; }
            .shift-item, .task-item { font-size: 0.72em; }
            .holiday-section { padding: 16px; }
            .holiday-grid { grid-template-columns: 1fr; }
            .modal-box { max-width: 100%; margin: 10px; }
            .modal-footer { flex-direction: column-reverse; }
            .modal-footer .btn { width: 100%; text-align: center; }
            .legend { border-radius: 0; flex-direction: column; align-items: flex-start; }
            .cal-nav { flex-direction: column; gap: 8px; }
            .nav-btn { width: 100%; }
            .month-year { text-align: center; }
        }
    </style>
</head>
<body>

<!-- Branch Selection -->
<div class="branch-screen" id="branchScreen">
    <div class="branch-card">
        <div class="logo">ğŸ“…</div>
        <h2>Jadwal PGI</h2>
        <p>Pilih cabang untuk melanjutkan</p>
        <div class="branch-buttons">
            <button class="branch-btn" onclick="selectBranch('bdg016')">ğŸ¢ BDG016</button>
            <button class="branch-btn" onclick="selectBranch('bdg026')">ğŸ¢ BDG026</button>
        </div>
    </div>
</div>

<!-- Main -->
<div class="container" id="mainContainer" style="display:none;">

    <div class="header">
        <div class="header-icon">ğŸ“…</div>
        <div class="header-text">
            <h1>Jadwal PGI â€” <span id="branchTitle">BDG016</span></h1>
            <p>Klik tanggal untuk menambah atau mengedit jadwal</p>
        </div>
        <div class="header-actions">
            <button class="btn-ghost" onclick="backToBranch()">â† Ganti Cabang</button>
        </div>
    </div>

    <!-- Calendar Mode Toggle -->
    <div class="calendar-toggle">
        <span class="toggle-label">Mode:</span>
        <div class="toggle-pills">
            <button class="toggle-pill active" id="pillShift" onclick="setMode('shift')">ğŸ‘¥ Kalender Shift</button>
            <button class="toggle-pill" id="pillTask" onclick="setMode('task')">ğŸ“‹ Kalender Tugas</button>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar" id="shiftToolbar">
        <span class="filter-label">ğŸ” Filter:</span>
        <select id="nameFilter" onchange="filterByName()">
            <option value="">Semua Orang</option>
        </select>
    </div>
    <div class="toolbar" id="taskToolbar" style="display:none;">
        <span class="filter-label">ğŸ“‹ Mode Tugas</span>
        <span style="font-size:0.85em;color:var(--text-muted);">Klik tanggal untuk tambah tugas. Tugas berulang muncul otomatis.</span>
    </div>

    <!-- Nav -->
    <div class="cal-nav">
        <button class="nav-btn" onclick="changeMonth(-1)">â† Sebelumnya</button>
        <div class="month-year" id="monthYear"></div>
        <button class="nav-btn" onclick="changeMonth(1)">Berikutnya â†’</button>
    </div>

    <!-- Calendar -->
    <div class="calendar-wrap">
        <div id="loading" class="loading">
            Memuat data <span class="loading-dot">â—</span><span class="loading-dot">â—</span><span class="loading-dot">â—</span>
        </div>
        <div id="calendarContent" style="display:none;">
            <div class="days-header">
                <div class="day-name">Sen</div>
                <div class="day-name">Sel</div>
                <div class="day-name">Rab</div>
                <div class="day-name">Kam</div>
                <div class="day-name">Jum</div>
                <div class="day-name weekend">Sab</div>
                <div class="day-name weekend">Min</div>
            </div>
            <div class="days-grid" id="daysGrid"></div>
        </div>
    </div>

    <!-- Holiday Section -->
    <div class="holiday-section" id="holidaySection">
        <div class="section-title">ğŸ—“ï¸ Libur Nasional Bulan Ini</div>
        <div class="holiday-grid" id="holidayGrid"></div>
    </div>

    <!-- Legend -->
    <div class="legend" id="legendSection">
        <span class="legend-label">Keterangan:</span>
        <div id="shiftLegend" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
            <div class="legend-item"><div class="legend-dot ld-libur"></div> Libur (L)</div>
            <div class="legend-item"><div class="legend-dot ld-pulsor"></div> Pulsor (P)</div>
            <div class="legend-item"><div class="legend-dot ld-siang"></div> Siang (S)</div>
            <div class="legend-item"><div class="legend-dot ld-normal"></div> Normal</div>
        </div>
        <div id="taskLegend" style="display:none;gap:12px;flex-wrap:wrap;align-items:center;">
            <div class="legend-item"><div class="legend-dot ld-oneoff"></div> Tugas Sekali</div>
            <div class="legend-item"><div class="legend-dot ld-recurring"></div> Tugas Berulang</div>
            <div class="legend-item"><div class="legend-dot" style="background:#0ea5e9"></div> ğŸ”§ Tugas Tetap</div>
        </div>
    </div>
</div>

<!-- â”€â”€ SHIFT MODAL â”€â”€ -->
<div class="modal" id="shiftModal">
    <div class="modal-box">
        <div class="modal-header">
            <h2 id="shiftModalTitle">Edit Jadwal Shift</h2>
            <button class="modal-close" onclick="closeShiftModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="help-box">
                <strong>Format:</strong> Nama (Kode)<br>
                <strong>(L)</strong> Libur &nbsp;|&nbsp; <strong>(P)</strong> Pulsor &nbsp;|&nbsp; <strong>(S)</strong> Siang &nbsp;|&nbsp; <em>tanpa kode</em> = Normal<br>
                Pisahkan dengan enter untuk banyak orang.
            </div>
            <div class="form-group">
                <label class="form-label">Data Shift</label>
                <textarea class="form-textarea" id="shiftInput" placeholder="Andi (L)&#10;Budi (P)&#10;Citra (S)&#10;Deni"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeShiftModal()">Batal</button>
            <button class="btn btn-danger" onclick="deleteShift()">ğŸ—‘ Hapus</button>
            <button class="btn btn-primary" onclick="saveShift()">Simpan</button>
        </div>
    </div>
</div>

<!-- â”€â”€ TASK MODAL â”€â”€ -->
<div class="modal" id="taskModal">
    <div class="modal-box">
        <div class="modal-header">
            <h2 id="taskModalTitle">Kelola Tugas</h2>
            <button class="modal-close" onclick="closeTaskModal()">âœ•</button>
        </div>
        <div class="modal-body">

            <!-- Existing tasks on this date -->
            <div id="existingTasksWrap">
                <label class="form-label">Tugas pada tanggal ini:</label>
                <div id="existingTasksList"></div>
            </div>

            <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;">

            <!-- Add new task -->
            <div class="form-group">
                <label class="form-label">Tambah Tugas Baru</label>
                <input class="form-input" id="taskName" placeholder="Nama tugas..." style="margin-bottom:10px;">

                <label class="form-label">Jenis Pengulangan</label>
                <select class="form-select" id="taskType" onchange="toggleRecurOptions()">
                    <option value="oneoff">Sekali (tanggal ini saja)</option>
                    <option value="weekly">Mingguan (hari tertentu)</option>
                    <option value="monthly">Bulanan (tanggal tertentu)</option>
                </select>

                <div class="recur-options" id="weeklyOptions">
                    <div class="recur-row">
                        <label>Hari:</label>
                        <div class="checkboxes">
                            <label class="day-check"><input type="checkbox" value="1"> Sen</label>
                            <label class="day-check"><input type="checkbox" value="2"> Sel</label>
                            <label class="day-check"><input type="checkbox" value="3"> Rab</label>
                            <label class="day-check"><input type="checkbox" value="4"> Kam</label>
                            <label class="day-check"><input type="checkbox" value="5"> Jum</label>
                            <label class="day-check"><input type="checkbox" value="6"> Sab</label>
                            <label class="day-check"><input type="checkbox" value="0"> Min</label>
                        </div>
                    </div>
                </div>

                <div class="recur-options" id="monthlyOptions">
                    <div class="recur-row">
                        <label>Tanggal:</label>
                        <div class="date-inputs" id="monthlyDates">
                            <input class="date-num-input" type="number" min="1" max="31" placeholder="tgl" id="mDate1">
                            <input class="date-num-input" type="number" min="1" max="31" placeholder="tgl" id="mDate2">
                            <input class="date-num-input" type="number" min="1" max="31" placeholder="tgl" id="mDate3">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeTaskModal()">Tutup</button>
            <button class="btn btn-primary task" onclick="addTask()">+ Tambah Tugas</button>
        </div>
    </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const today = new Date();
let currentMonth = today.getMonth();
let currentYear  = today.getFullYear();
let shiftData    = {};
let taskData     = { oneoff: {}, weekly: [], monthly: [] };
let currentBranch = 'bdg016';
let calendarMode  = 'shift';
let selectedDay   = null;
let selectedFilter = '';

const SCRIPT_URLS = {
    bdg016: 'https://script.google.com/macros/s/AKfycbzGXFycufPgLbXSNzxdxQBmE9VAXYxeGrKr6H81fIOOgUflIc2f9nOhQ6HohfPZYqw0Vw/exec',
    bdg026: 'https://script.google.com/macros/s/AKfycbwZwB9wS0XkopObAh0uTzSK41ZIi4vRQRBCl_HlvQiP12ln96vxcKFd_qC_lGcXwzzE/exec'
};

const TASK_STORAGE_PREFIX = 'pgi_tasks_';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PERMANENT TASKS (hardcoded, always shown)
//  monthly-odd = hanya bulan ganjil (Jan,Mar,Mei,Jul,Sep,Nov)
//  m is 0-indexed: bulan ganjil = m % 2 === 0
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PERMANENT_TASKS = [
    { name: 'Perawatan PC',       type: 'weekly',      days:  [6]      },
    { name: 'Perawatan PC',       type: 'monthly-odd', dates: [15]     },
    { name: 'Penggantian Air Uji',type: 'monthly',     dates: [1, 16]  },
];

function getPermanentTasksForDate(y, m, d) {
    const dow = new Date(y, m, d).getDay();
    const results = [];
    PERMANENT_TASKS.forEach(t => {
        if (t.type === 'weekly' && t.days.includes(dow)) {
            results.push({ name: t.name, kind: 'permanent-recurring' });
        } else if (t.type === 'monthly' && t.dates.includes(d)) {
            results.push({ name: t.name, kind: 'permanent-recurring' });
        } else if (t.type === 'monthly-odd' && t.dates.includes(d) && (m % 2 === 0)) {
            results.push({ name: t.name, kind: 'permanent-recurring' });
        }
    });
    return results;
}

const monthNames = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
const dayNames   = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  NATIONAL HOLIDAYS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nationalHolidays = {
    '2025-01-01':'Tahun Baru 2025',
    '2025-01-16':'Isra Mikraj Nabi Muhammad SAW',
    '2025-01-29':'Tahun Baru Imlek 2576',
    '2025-03-29':'Hari Suci Nyepi (Tahun Baru Saka 1947)',
    '2025-03-31':'Wafat Isa Al Masih',
    '2025-04-01':'Cuti Bersama Wafat Isa Al Masih',
    '2025-04-02':'Cuti Bersama Idul Fitri',
    '2025-04-03':'Idul Fitri 1446 H',
    '2025-04-04':'Idul Fitri 1446 H',
    '2025-04-07':'Cuti Bersama Idul Fitri',
    '2025-05-01':'Hari Buruh Internasional',
    '2025-05-12':'Kenaikan Isa Al Masih',
    '2025-05-29':'Hari Raya Waisak 2569',
    '2025-06-01':'Hari Lahir Pancasila',
    '2025-06-06':'Idul Adha 1446 H',
    '2025-06-27':'Tahun Baru Islam 1447 H',
    '2025-08-17':'Hari Kemerdekaan RI',
    '2025-09-05':'Maulid Nabi Muhammad SAW',
    '2025-12-25':'Hari Raya Natal',
    '2025-12-26':'Cuti Bersama Hari Raya Natal',
    '2026-01-01':'Tahun Baru 2026',
    '2026-01-06':'Isra Mikraj Nabi Muhammad SAW',
    '2026-02-17':'Tahun Baru Imlek 2577',
    '2026-03-19':'Hari Suci Nyepi (Tahun Baru Saka 1948)',
    '2026-03-20':'Idul Fitri 1447 H',
    '2026-03-21':'Idul Fitri 1447 H',
    '2026-04-03':'Wafat Isa Al Masih',
    '2026-05-01':'Hari Buruh Internasional',
    '2026-05-14':'Kenaikan Isa Al Masih',
    '2026-05-18':'Hari Raya Waisak 2570',
    '2026-05-27':'Idul Adha 1447 H',
    '2026-06-01':'Hari Lahir Pancasila',
    '2026-06-17':'Tahun Baru Islam 1448 H',
    '2026-08-17':'Hari Kemerdekaan RI',
    '2026-08-26':'Maulid Nabi Muhammad SAW',
    '2026-12-25':'Hari Raya Natal'
};

function isRedDate(y, m, d) {
    const dk = dateKey(y, m+1, d);
    return new Date(y, m, d).getDay() === 0 || !!nationalHolidays[dk];
}
function getHolidayName(y, m, d) {
    return nationalHolidays[dateKey(y, m+1, d)] || null;
}
function dateKey(y, m, d) {
    return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  BRANCH / MODE SELECTION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectBranch(branch) {
    currentBranch = branch;
    document.getElementById('branchTitle').textContent = branch.toUpperCase();
    document.getElementById('branchScreen').classList.add('hidden');
    document.getElementById('mainContainer').style.display = 'block';
    selectedFilter = '';
    loadData();
    loadTasks();
}

function backToBranch() {
    document.getElementById('branchScreen').classList.remove('hidden');
    document.getElementById('mainContainer').style.display = 'none';
    shiftData = {};
}

function setMode(mode) {
    calendarMode = mode;
    document.getElementById('pillShift').className = 'toggle-pill' + (mode === 'shift' ? ' active' : '');
    document.getElementById('pillTask').className  = 'toggle-pill' + (mode === 'task'  ? ' task-active' : '');
    document.getElementById('shiftToolbar').style.display = mode === 'shift' ? 'flex' : 'none';
    document.getElementById('taskToolbar').style.display  = mode === 'task'  ? 'flex' : 'none';
    document.getElementById('shiftLegend').style.display  = mode === 'shift' ? 'flex' : 'none';
    document.getElementById('taskLegend').style.display   = mode === 'task'  ? 'flex' : 'none';
    renderCalendar();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SHIFT DATA (Google Sheets)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
    try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('calendarContent').style.display = 'none';
        const res  = await fetch(SCRIPT_URLS[currentBranch]);
        const data = await res.json();
        shiftData  = {};
        data.forEach(row => {
            if (!row.date) return;
            let dk = row.date;
            if (dk.includes('T')) {
                const d = new Date(dk);
                dk = dateKey(d.getFullYear(), d.getMonth()+1, d.getDate());
            }
            shiftData[dk] = row.names || '';
        });
        document.getElementById('loading').style.display = 'none';
        document.getElementById('calendarContent').style.display = 'block';
        updateNameFilter();
        renderCalendar();
        renderHolidays();
    } catch(e) {
        console.error(e);
        document.getElementById('loading').innerHTML = 'Gagal memuat data. <button onclick="loadData()" style="margin-left:8px;padding:6px 14px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">Coba Lagi</button>';
    }
}

function updateNameFilter() {
    const names = new Set();
    Object.values(shiftData).forEach(s => {
        if (s) s.split('\n').forEach(line => {
            const n = line.replace(/\s*\([LPS]\)/g,'').trim();
            if (n) names.add(n);
        });
    });
    const sel = document.getElementById('nameFilter');
    sel.innerHTML = '<option value="">Semua Orang</option>';
    [...names].sort().forEach(n => {
        const o = document.createElement('option');
        o.value = o.textContent = n;
        sel.appendChild(o);
    });
}

function filterByName() {
    selectedFilter = document.getElementById('nameFilter').value;
    renderCalendar();
}

function getShiftClass(text) {
    if (text.includes('(L)')) return 'libur';
    if (text.includes('(P)')) return 'pulsor';
    if (text.includes('(S)')) return 'siang';
    return 'normal';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TASK DATA (localStorage)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function taskStorageKey() {
    return TASK_STORAGE_PREFIX + currentBranch;
}

function loadTasks() {
    try {
        const raw = localStorage.getItem(taskStorageKey());
        if (raw) taskData = JSON.parse(raw);
        else taskData = { oneoff: {}, weekly: [], monthly: [] };
    } catch(e) {
        taskData = { oneoff: {}, weekly: [], monthly: [] };
    }
}

function saveTasks() {
    localStorage.setItem(taskStorageKey(), JSON.stringify(taskData));
}

// Get tasks visible on a specific date
function getTasksForDate(y, m, d) {
    const dk = dateKey(y, m+1, d);
    const dow = new Date(y, m, d).getDay();
    const results = [];

    // Permanent tasks first
    getPermanentTasksForDate(y, m, d).forEach(t => results.push(t));

    // One-off
    (taskData.oneoff[dk] || []).forEach(t => {
        results.push({ ...t, kind: 'oneoff', dk });
    });

    // Weekly (user-created)
    taskData.weekly.forEach(t => {
        if (t.days.includes(dow)) results.push({ ...t, kind: 'recurring' });
    });

    // Monthly (user-created)
    taskData.monthly.forEach(t => {
        if (t.dates.includes(d)) results.push({ ...t, kind: 'recurring' });
    });

    return results;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RENDER CALENDAR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCalendar() {
    document.getElementById('monthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;
    const grid = document.getElementById('daysGrid');
    grid.innerHTML = '';

    const jsDay   = new Date(currentYear, currentMonth, 1).getDay();
    const firstDay = jsDay === 0 ? 6 : jsDay - 1;
    const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
        const e = document.createElement('div');
        e.className = 'day-cell empty';
        grid.appendChild(e);
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const dk  = dateKey(currentYear, currentMonth+1, day);
        const red = isRedDate(currentYear, currentMonth, day);
        const hname = getHolidayName(currentYear, currentMonth, day);
        const isToday = (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear());

        const cell = document.createElement('div');
        cell.className = 'day-cell' + (red ? ' red-day' : '') + (isToday ? ' today' : '');

        // Day number
        const numDiv = document.createElement('div');
        numDiv.className = 'day-number' + (red ? ' red' : '') + (isToday ? ' today-num' : '');
        numDiv.textContent = day;
        cell.appendChild(numDiv);

        // Holiday label
        if (hname) {
            const hl = document.createElement('span');
            hl.className = 'holiday-label';
            hl.textContent = hname;
            cell.appendChild(hl);
        }

        if (calendarMode === 'shift') {
            const list = document.createElement('div');
            list.className = 'shift-list';
            if (shiftData[dk]) {
                shiftData[dk].split('\n').filter(s => s.trim()).forEach(shift => {
                    const name = shift.replace(/\s*\([LPS]\)/g,'').trim();
                    if (selectedFilter && name !== selectedFilter) return;
                    const item = document.createElement('div');
                    item.className = `shift-item ${getShiftClass(shift)}`;
                    item.textContent = shift.trim();
                    list.appendChild(item);
                });
            }
            cell.appendChild(list);
            cell.onclick = () => openShiftModal(day);
        } else {
            const list = document.createElement('div');
            list.className = 'task-list';
            const tasks = getTasksForDate(currentYear, currentMonth, day);
            tasks.forEach(t => {
                const item = document.createElement('div');
                item.className = `task-item ${t.kind}`;
                item.innerHTML = `<span class="task-icon">${t.kind === 'permanent-recurring' ? 'ğŸ”§' : t.kind === 'recurring' ? 'ğŸ”' : 'ğŸ“Œ'}</span>${t.name}`;
                list.appendChild(item);
            });
            cell.appendChild(list);
            cell.onclick = () => openTaskModal(day);
        }

        grid.appendChild(cell);
    }

    renderHolidays();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RENDER HOLIDAYS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHolidays() {
    const grid = document.getElementById('holidayGrid');
    grid.innerHTML = '';

    const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
    const holidays = [];

    for (let d = 1; d <= daysInMonth; d++) {
        const dk = dateKey(currentYear, currentMonth+1, d);
        const hn = nationalHolidays[dk];
        if (hn) {
            const dayOfWeek = dayNames[new Date(currentYear, currentMonth, d).getDay()];
            holidays.push({ day: d, dayName: dayOfWeek, name: hn });
        }
    }

    if (holidays.length === 0) {
        grid.innerHTML = '<span class="no-holiday">Tidak ada libur nasional bulan ini.</span>';
        return;
    }

    holidays.forEach(h => {
        const chip = document.createElement('div');
        chip.className = 'holiday-chip';
        chip.innerHTML = `<span class="hdate">${String(h.day).padStart(2,'0')} ${monthNames[currentMonth].slice(0,3)}<br>${h.dayName}</span><span class="hname">${h.name}</span>`;
        grid.appendChild(chip);
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SHIFT MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openShiftModal(day) {
    selectedDay = day;
    const dk = dateKey(currentYear, currentMonth+1, day);
    document.getElementById('shiftModalTitle').textContent =
        `Jadwal Shift ${currentBranch.toUpperCase()} â€” ${day} ${monthNames[currentMonth]} ${currentYear}`;
    document.getElementById('shiftInput').value = shiftData[dk] || '';
    document.getElementById('shiftModal').classList.add('active');
    document.getElementById('shiftInput').focus();
}

function closeShiftModal() {
    document.getElementById('shiftModal').classList.remove('active');
    selectedDay = null;
}

async function saveShift() {
    const shifts = document.getElementById('shiftInput').value.trim();
    const dk = dateKey(currentYear, currentMonth+1, selectedDay);
    try {
        await fetch(SCRIPT_URLS[currentBranch], {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ date: dk, names: shifts })
        });
        if (shifts) shiftData[dk] = shifts;
        else delete shiftData[dk];
        updateNameFilter(); renderCalendar(); closeShiftModal();
    } catch(e) { alert('Gagal menyimpan. Silakan coba lagi.'); }
}

async function deleteShift() {
    if (!confirm('Hapus semua jadwal di tanggal ini?')) return;
    const dk = dateKey(currentYear, currentMonth+1, selectedDay);
    try {
        await fetch(SCRIPT_URLS[currentBranch], {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ date: dk, names: '' })
        });
        delete shiftData[dk];
        updateNameFilter(); renderCalendar(); closeShiftModal();
    } catch(e) { alert('Gagal menghapus. Silakan coba lagi.'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TASK MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openTaskModal(day) {
    selectedDay = day;
    document.getElementById('taskModalTitle').textContent =
        `Tugas â€” ${day} ${monthNames[currentMonth]} ${currentYear}`;
    document.getElementById('taskName').value = '';
    document.getElementById('taskType').value = 'oneoff';

    // Reset recurring options
    document.getElementById('weeklyOptions').classList.remove('visible');
    document.getElementById('monthlyOptions').classList.remove('visible');
    document.querySelectorAll('#weeklyOptions input[type=checkbox]').forEach(cb => cb.checked = false);
    document.getElementById('mDate1').value = '';
    document.getElementById('mDate2').value = '';
    document.getElementById('mDate3').value = '';

    renderExistingTasks(day);
    document.getElementById('taskModal').classList.add('active');
    document.getElementById('taskName').focus();
}

function closeTaskModal() {
    document.getElementById('taskModal').classList.remove('active');
    selectedDay = null;
}

function toggleRecurOptions() {
    const v = document.getElementById('taskType').value;
    document.getElementById('weeklyOptions').classList.toggle('visible', v === 'weekly');
    document.getElementById('monthlyOptions').classList.toggle('visible', v === 'monthly');
}

function renderExistingTasks(day) {
    const wrap = document.getElementById('existingTasksList');
    wrap.innerHTML = '';
    const dk = dateKey(currentYear, currentMonth+1, day);
    const dow = new Date(currentYear, currentMonth, day).getDay();

    // Permanent tasks (read-only)
    getPermanentTasksForDate(currentYear, currentMonth, day).forEach(t => {
        const div = document.createElement('div');
        div.className = 'task-existing-item';
        div.style.background = '#e0f2fe';
        div.innerHTML = `<span>ğŸ”§ ${t.name}<span class="task-badge" style="background:#bae6fd;color:#0369a1;">Tugas Tetap</span></span>`;
        const lk = document.createElement('span');
        lk.textContent = 'ğŸ”’';
        lk.title = 'Tugas tetap tidak dapat dihapus';
        lk.style.cssText = 'padding:2px 6px;color:#0369a1;font-size:0.9em;';
        div.appendChild(lk);
        wrap.appendChild(div);
    });

    // One-off on this date
    (taskData.oneoff[dk] || []).forEach((t, idx) => {
        wrap.appendChild(buildTaskRow(t.name, 'oneoff', () => {
            taskData.oneoff[dk].splice(idx, 1);
            if (taskData.oneoff[dk].length === 0) delete taskData.oneoff[dk];
            saveTasks(); renderExistingTasks(day); renderCalendar();
        }));
    });

    // Weekly matching this day
    taskData.weekly.forEach((t, idx) => {
        if (!t.days.includes(dow)) return;
        wrap.appendChild(buildTaskRow(t.name, 'recurring', () => {
            if (confirm(`Hapus tugas berulang "${t.name}" dari semua hari?`)) {
                taskData.weekly.splice(idx, 1);
                saveTasks(); renderExistingTasks(day); renderCalendar();
            }
        }));
    });

    // Monthly matching this date
    taskData.monthly.forEach((t, idx) => {
        if (!t.dates.includes(day)) return;
        wrap.appendChild(buildTaskRow(t.name, 'recurring', () => {
            if (confirm(`Hapus tugas berulang "${t.name}" dari semua tanggal?`)) {
                taskData.monthly.splice(idx, 1);
                saveTasks(); renderExistingTasks(day); renderCalendar();
            }
        }));
    });

    if (wrap.children.length === 0) {
        wrap.innerHTML = '<div style="font-size:0.85em;color:var(--text-muted);font-style:italic;">Belum ada tugas pada tanggal ini.</div>';
    }
}

function buildTaskRow(name, kind, onDelete) {
    const div = document.createElement('div');
    div.className = 'task-existing-item';
    div.innerHTML = `<span>${name}<span class="task-badge ${kind}">${kind === 'recurring' ? 'ğŸ” Berulang' : 'ğŸ“Œ Sekali'}</span></span>`;
    const btn = document.createElement('button');
    btn.className = 'task-del-btn'; btn.textContent = 'âœ•';
    btn.onclick = onDelete;
    div.appendChild(btn);
    return div;
}

function addTask() {
    const name = document.getElementById('taskName').value.trim();
    if (!name) { document.getElementById('taskName').focus(); return; }
    const type = document.getElementById('taskType').value;
    const dk   = dateKey(currentYear, currentMonth+1, selectedDay);

    if (type === 'oneoff') {
        if (!taskData.oneoff[dk]) taskData.oneoff[dk] = [];
        taskData.oneoff[dk].push({ name });

    } else if (type === 'weekly') {
        const days = [...document.querySelectorAll('#weeklyOptions input[type=checkbox]:checked')].map(cb => parseInt(cb.value));
        if (days.length === 0) { alert('Pilih minimal satu hari.'); return; }
        taskData.weekly.push({ name, days });

    } else if (type === 'monthly') {
        const dates = [
            document.getElementById('mDate1').value,
            document.getElementById('mDate2').value,
            document.getElementById('mDate3').value
        ].map(v => parseInt(v)).filter(v => !isNaN(v) && v >= 1 && v <= 31);
        if (dates.length === 0) { alert('Masukkan minimal satu tanggal.'); return; }
        taskData.monthly.push({ name, dates });
    }

    saveTasks();
    document.getElementById('taskName').value = '';
    renderExistingTasks(selectedDay);
    renderCalendar();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MONTH NAV
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function changeMonth(dir) {
    currentMonth += dir;
    if (currentMonth > 11) { currentMonth = 0; currentYear++; }
    else if (currentMonth < 0) { currentMonth = 11; currentYear--; }
    renderCalendar();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CLOSE MODAL ON BACKDROP CLICK
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('shiftModal').addEventListener('click', function(e) {
    if (e.target === this) closeShiftModal();
});
document.getElementById('taskModal').addEventListener('click', function(e) {
    if (e.target === this) closeTaskModal();
});
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { closeShiftModal(); closeTaskModal(); }
});
</script>
</body>
</html>
